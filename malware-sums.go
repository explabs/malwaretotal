package main

import (
	"crypto/md5"
	"encoding/json"
	"fmt"
	"io"
	"io/ioutil"
	"net/http"
	"os"

	"github.com/gin-gonic/gin"
)

const filename = "malware.json"

type Malware struct {
	Data []Data `json:"data"`
}
type Data struct {
	Title     string `json:"title"`
	Sha256Sum string `json:"sha256sum"`
	Md5Sum    string `json:"md5sum"`
	Checksum  string `json:"checksum"`
	Info      string `json:"info"`
	Counter   int64  `json:"counter"`
}

func (m *Malware) LoadData(filename string) {
	if fileExists(filename) {
		file, _ := ioutil.ReadFile(filename)
		_ = json.Unmarshal(file, m)
	} else {
		return
	}

}

func (m *Malware) SearchSum(checksum string) *Data {
	for i, row := range m.Data {
		if checksum == row.Md5Sum || checksum == row.Sha256Sum {
			m.Data[i].Counter += 1
			return &row
		}
	}
	return nil
}

func (m *Malware) SaveData(filename string) {
	file, _ := json.MarshalIndent(m, "", " ")
	_ = ioutil.WriteFile(filename, file, 0644)
}

func CheckSum(c *gin.Context) {
	sum := c.PostForm("sum")
	fmt.Println(sum)
	var m Malware
	m.LoadData(filename)
	data := m.SearchSum(sum)
	m.SaveData(filename)
	if data != nil {
		c.HTML(http.StatusOK, "file_sum.html", gin.H{"data": data})
		return
	}
	c.HTML(http.StatusOK, "file_sum.html", gin.H{"NotAMalware": "Undetected"})
}

func CheckFile(c *gin.Context) {
	file, _ := c.FormFile("sus_file")
	fileOpened, _ := file.Open()
	fileData, _ := ioutil.ReadAll(fileOpened)
	hasher := md5.New()
	io.WriteString(hasher, string(fileData))
	stringHash := fmt.Sprintf("%x", hasher.Sum(nil))
	fmt.Println(stringHash)
	var m Malware
	m.LoadData(filename)
	data := m.SearchSum(stringHash)
	m.SaveData(filename)
	if data != nil {
		c.HTML(http.StatusOK, "file_upload.html", gin.H{"data": data})
		return
	}
	c.HTML(http.StatusOK, "file_upload.html", gin.H{"NotAMalware": "Undetected"})

}

func IndexHandler(c *gin.Context) {
	c.HTML(http.StatusOK, "index.html", nil)
}

func fileExists(filename string) bool {
	info, err := os.Stat(filename)
	if os.IsNotExist(err) {
		return false
	}
	return !info.IsDir()
}

//curl http://localhost:8000/malware -XPOST -F 'sum=d41d8cd98f00b204e9800998ecf8427e'
